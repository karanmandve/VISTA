<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Open+Sans:300,400,600&amp;lang=en.css"/>
    <link rel="stylesheet" href="../../static/css/navbar.css">
    <link rel="stylesheet" href="../../static/css/dashboard.css">
    <title>Dashboard</title>
</head>

<body>
    <div class="nav-wrapper">
        <nav class="navbar">
            <img src="../../static/logoblack.png" alt="Company Logo">
            <ul class="nav no-search">
                <li class="nav-item"><a href="/about">About</a></li>
                <li class="nav-item"><a href="#">Contact Us</a></li>
            </ul>
        </nav>
    </div>
    <div class="new">
        <div class="left">
            <div class="title">Create new test</div>
            <a href="./create_test">
                <div class="box">
                    <div class="up">
                        <div class="plus"></div>
                    </div>
                    <div class="down">Blank</div>
                </div>
            </a>
        </div>
        <div class="right">
            <div id="active_title" class="title">No active test</div>
            <div id="active_container">
            </div>
        </div>
    </div>
    <div id="recent">
        <div id="recent_title"  style="margin: 1.5% 0 0 12%;font-family: 'Bold';">No Recent Test</div>
        <div id="test_container">
            <template id="t0">
                <div  class="test_card" >
                    <div class="preview"></div>
                    <i class="fa fa-ellipsis-v more"  style="color: grey;">
                        <div  class="dropdown-content">
                            <a><i class="fa fa-flash" style="font-size:20px;color:grey;"></i><div style="margin-left:-3vh">Activate</div></a>
                            <a id="password"><i class="fa fa-hashtag" style="font-size:20px;color:grey;"></i><div style="margin-left:-3vh">Passwords</div></a>
                            <a><i class="fa fa-group" style="font-size:20px;color:grey;"></i><div style="margin-left:-3vh">Responses</div></a>
                            <a><i class="fa fa-eye" style="font-size:20px;color:grey;"></i><div style="margin-left:-3vh">View</div></a>
                            <a style="color:tomato;"><i class="fa fa-trash-o" style="font-size:20px;color:tomato;"></i><div style="margin-left:-3vh">Delete</div></a>
                        </div>
                    </i>
                <h1 style="padding: 6% 0 0 12%;font-size: unset;font-family: 'Bold';margin-bottom: 0;">DBMS</h1>
                <p style="padding: 2% 12%;font-size: small; word-spacing: 5px;">desc</p>
                </div>
            </template>
        </div>
    </div>
     <br>
     <br>
<script>
   var test_count=0;
    
    function refresh_recent(){
        let recent_title=document.getElementById("recent_title");
        let test=document.getElementById("test_container");
        let active=document.getElementById("active_container");
        fetch("./all-exams").then((res)=>res.json()).then((data)=>{
           let parent= document.getElementById("test_container");
           while(parent.childElementCount !=1){
            parent.removeChild(parent.lastChild);
           }
            count=0;
            // remove active_exam = key and store in another variable to know which subject is activate
            let active_subject=data.active_subject;
            data = Object.keys(data);
            console.log(active_subject);
            
            for (let index = 0; index < data.length;index++) {
                const element = data[index];

                node=document.getElementById("t0");
                copy=node.content.children[0].cloneNode(true);
                copy.children[1].addEventListener("click",function show_more(e){if(typeof(e.path[0].children[0]) !="undefined"){e.path[0].children[0].classList.toggle("show");}});
            copy.children[1].children[0].children[2].addEventListener("click",(e)=>{window.location="./show_test/"+e.path[4].children[2].value;});
                
                
                if(element != "active_subject"){
                    if(active_subject !=element){
                        // copy.style.background=bg[count%2];
                        copy.id=++test_count;
                        copy.children[1].children[0].children[0].addEventListener("click",(e)=>{
                            if(active.childElementCount==1){
                                alert("Some test is already active Please deactivate that first to activate this!!");
                            }
                            else{
                                fetch("./active-exam/{'subject_name':'"+e.path[4].children[2].value+"'}").then((res)=>{
                                    if(active.childElementCount !=0){
                                            active.removeChild(active.lastChild);
                                    }
                                    refresh_recent();
                                })
                            }
                           
                        });
                        copy.children[1].children[0].children[3].addEventListener("click",(e)=>{console.log(e);fetch("./delete_subject/"+e.path[4].children[2].value).then((res)=>{
                            document.getElementById("active_container").removeChild(document.getElementById("active_container").lastChild);
                            refresh_recent();
                        })});
                        copy.children[2].value=element;
                        copy.children[2].innerText=element.length>15?element.slice(0,15)+"...":element;
                        copy.children[3].innerHTML='<i class="fa fa-dot-circle-o"></i>&nbsp;Inactive';
                        copy.children[3].style.color="blue";
                        copy.children[0].style.background="url('../../static/icon.jpg')";
                        copy.children[0].style.backgroundSize="cover";
                        document.getElementById("test_container").appendChild(copy);
                        count++;
                        
                        
                    }
                }
                else if(active_subject !=""){ 
                    copy.children[1].children[0].children[0].innerHTML='<i class="fa fa-flash" style="font-size:20px;color:grey;"></i><div style="margin-left:-3vh">&nbsp;Deactivate</div>';                               
                    copy.children[1].children[0].children[0].addEventListener("click",(e)=>{fetch("./active-exam/{'subject_name':'"+e.path[4].children[2].value+"','is_active':False}").then((res)=>{
                            document.getElementById("active_container").removeChild(document.getElementById("active_container").lastChild);
                            refresh_recent();
                        })});
                    copy.children[1].children[0].children[3].addEventListener("click",(e)=>{alert("please deactivate this test first then delete!!")});
                    copy.children[2].value=active_subject;
                    copy.children[2].innerText=active_subject.length>15?active_subject.slice(0,15)+"...":active_subject;
                    copy.children[3].innerHTML='<i class="fa fa-dot-circle-o"></i>&nbsp;Active';
                    copy.children[3].style.color="tomato";
                    copy.style.position="relative";
                    copy.style.zIndex="2";
                    copy.style.margin="-2% 0 0 20%";
                    copy.children[0].style.background="url('../../static/icon.jpg')";
                    copy.children[0].style.backgroundSize="cover";
                    document.getElementById("active_container").appendChild(copy);
                    
                }  
            }
            if(test.childElementCount ==1){
            recent_title.innerText="No recent tests";
            }
        else{
            recent_title.innerText="Recent tests";
            }
            if(active.childElementCount ==0){
            document.getElementById("active_title").innerText="No active tests";
            }
        else{
            document.getElementById("active_title").innerText="Active tests";
            }
        });
       
    }
    
    window.onclick = function(event) {
      let tests= document.getElementsByClassName("test_card");
      for (let index = 0; index < tests.length; index++) {
        const element = tests[index];
        if(element!=event.path[1]){
            element.children[1].children[0].classList.remove("show");
        }
      }
    }
    refresh_recent();
</script>
<!-- use xlsx.full.min.js from version 0.19.0 -->
<script lang="javascript" src="https://cdn.sheetjs.com/xlsx-0.19.0/package/dist/xlsx.full.min.js"></script>
<script>

    document.getElementById("password").onclick= function(event){
        fetch('/generate-passwords/30')
        .then((response) => response.json())
        .then((data) => {
            const objs=data.filter(row=> {});
            const rows=data.map(row =>({
                number: row.number,
                password: row.password,
                sign: null
            }));
           const worksheet= XLSX.utils.json_to_sheet(rows);
           const workbook = XLSX.utils.book_new();
           XLSX.utils.book_append_sheet(workbook,worksheet,"Passwords");
           XLSX.utils.sheet_add_aoa(worksheet,[["number","password"]],{origin: "A1"});
           const max_width= rows.reduce((w,r) => Math.max(w,r.password.length),10);
           worksheet["!cols"]=[{ wch: max_width}];
           XLSX.writeFile(workbook,"Passwords.xlsx",{compression: false});
        })		
    }

    </script>

</body>
</html>
